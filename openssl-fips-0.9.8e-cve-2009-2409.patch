Skip signature validation on selfsigned certificates and
drop MD2 algorithm from the list of algorithms added to
EVP tables by default. (CVE-2009-2409)
diff -up openssl-fips-0.9.8e/crypto/evp/c_alld.c.nomd2 openssl-fips-0.9.8e/crypto/evp/c_alld.c
--- openssl-fips-0.9.8e/crypto/evp/c_alld.c.nomd2	2009-04-15 13:48:51.000000000 +0200
+++ openssl-fips-0.9.8e/crypto/evp/c_alld.c	2010-01-14 09:24:00.000000000 +0100
@@ -69,9 +69,6 @@ void OpenSSL_add_all_digests(void)
 	if (!FIPS_mode())
 		{
 #endif
-#ifndef OPENSSL_NO_MD2
-	EVP_add_digest(EVP_md2());
-#endif
 #ifndef OPENSSL_NO_MD4
 	EVP_add_digest(EVP_md4());
 #endif
diff -up openssl-fips-0.9.8e/crypto/x509/x509_vfy.c.nomd2 openssl-fips-0.9.8e/crypto/x509/x509_vfy.c
--- openssl-fips-0.9.8e/crypto/x509/x509_vfy.c.nomd2	2009-04-15 13:48:51.000000000 +0200
+++ openssl-fips-0.9.8e/crypto/x509/x509_vfy.c	2010-01-14 09:22:49.000000000 +0100
@@ -1013,7 +1013,11 @@ static int internal_verify(X509_STORE_CT
 	while (n >= 0)
 		{
 		ctx->error_depth=n;
-		if (!xs->valid)
+
+		/* Skip signature check for self signed certificates. It
+		 * doesn't add any security and just wastes time.
+		 */
+		if (!xs->valid && xs != xi)
 			{
 			if ((pkey=X509_get_pubkey(xi)) == NULL)
 				{
@@ -1023,13 +1027,6 @@ static int internal_verify(X509_STORE_CT
 				if (!ok) goto end;
 				}
 			else if (X509_verify(xs,pkey) <= 0)
-				/* XXX  For the final trusted self-signed cert,
-				 * this is a waste of time.  That check should
-				 * optional so that e.g. 'openssl x509' can be
-				 * used to detect invalid self-signatures, but
-				 * we don't verify again and again in SSL
-				 * handshakes and the like once the cert has
-				 * been declared trusted. */
 				{
 				ctx->error=X509_V_ERR_CERT_SIGNATURE_FAILURE;
 				ctx->current_cert=xs;
diff -up openssl-fips-0.9.8e/ssl/ssl_algs.c.nomd2 openssl-fips-0.9.8e/ssl/ssl_algs.c
--- openssl-fips-0.9.8e/ssl/ssl_algs.c.nomd2	2009-04-15 14:09:42.000000000 +0200
+++ openssl-fips-0.9.8e/ssl/ssl_algs.c	2010-01-14 09:23:10.000000000 +0100
@@ -94,9 +94,6 @@ int SSL_library_init(void)
 	EVP_add_cipher(EVP_seed_cbc());
 #endif
 
-#ifndef OPENSSL_NO_MD2
-	EVP_add_digest(EVP_md2());
-#endif
 #ifndef OPENSSL_NO_MD5
 	EVP_add_digest(EVP_md5());
 	EVP_add_digest_alias(SN_md5,"ssl2-md5");
